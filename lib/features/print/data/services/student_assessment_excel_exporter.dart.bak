import 'dart:io';

import 'package:intl/intl.dart';
import 'package:path_provider/path_provider.dart';
import 'package:share_plus/share_plus.dart';
import 'package:syncfusion_flutter_xlsio/xlsio.dart' as xlsio;

// =============================================================================
// DATA MODELS
// =============================================================================

/// Represents a single student's assessment data across all weeks.
class StudentAssessmentData {
  final int? rowIndex;
  final String name;
  final Map<int, List<int>> weeklyScores;

  const StudentAssessmentData({
    this.rowIndex,
    required this.name,
    required this.weeklyScores,
  });

  int getWeekTotal(int weekNumber) {
    final scores = weeklyScores[weekNumber];
    if (scores == null || scores.isEmpty) return 0;
    return scores.fold(0, (sum, score) => sum + score);
  }
}

/// Metadata for the export
class AssessmentExportMetadata {
  final String administration;
  final String school;
  final String subject;
  final String academicYear;
  final String governorate;
  final String grade;
  final String className;
  final Map<int, DateTime>? weekStartDates;

  const AssessmentExportMetadata({
    required this.administration,
    required this.school,
    required this.subject,
    required this.academicYear,
    required this.governorate,
    required this.grade,
    required this.className,
    this.weekStartDates,
  });
}

// =============================================================================
// EXCEL COLUMN MAPPING CONFIGURATION
// =============================================================================

class ExcelColumnConfig {
  static const int serialNumberColumn = 2; // Column B
  static const int studentNameColumn = 3; // Column C
  static const int firstStudentRow = 7;
  static const int evaluationsPerWeek = 7;
  static const int columnsPerWeek = 8;
  static const int firstWeekStartColIndex = 4; // Column D

  static int getEvaluationColumn(int weekNumber, int evaluationIndex) {
    return firstWeekStartColIndex +
        ((weekNumber - 1) * columnsPerWeek) +
        evaluationIndex;
  }

  static int getTotalColumn(int weekNumber) {
    return firstWeekStartColIndex +
        ((weekNumber - 1) * columnsPerWeek) +
        evaluationsPerWeek;
  }
}

// =============================================================================
// MAIN EXPORTER SERVICE (SYNCFUSION)
// =============================================================================

class StudentAssessmentExcelExporter {
  StudentAssessmentExcelExporter();

  Future<String> export({
    required AssessmentExportMetadata metadata,
    required List<StudentAssessmentData> students,
    required List<int> weeksToExport,
  }) async {
    try {
      final workbook = xlsio.Workbook();
      final sheet = workbook.worksheets[0];
      sheet.name = 'التقرير';
      sheet.isRightToLeft = true;

      // 1. Build Headers
      _buildHeaders(sheet, metadata);

      // 2. Build Week Headers
      _buildWeekHeaders(sheet, weeksToExport, metadata);

      // 3. Write Student Data
      _writeStudentData(sheet, students, weeksToExport);

      // 4. Auto-fit name column
      sheet.autoFitColumn(ExcelColumnConfig.studentNameColumn);

      // 5. Save and Share
      final timestamp = DateFormat('yyyyMMdd_HHmmss').format(DateTime.now());
      final filename = 'كشف_درجات_${metadata.subject}_$timestamp.xlsx';

      final List<int> fileBytes = workbook.saveAsStream();
      final directory = await getTemporaryDirectory();
      final filePath = '${directory.path}/$filename';
      final file = File(filePath);
      await file.writeAsBytes(fileBytes, flush: true);

      await Share.shareXFiles([XFile(filePath)], subject: filename);

      workbook.dispose();
      return filePath;
    } catch (e) {
      throw Exception('Failed to export assessment Excel: $e');
    }
  }

  void _buildHeaders(xlsio.Worksheet sheet, AssessmentExportMetadata metadata) {
    // Top Left: Directorate, Administration, School
    var range = sheet.getRangeByIndex(1, 1, 1, 3);
    range.merge();
    range.setText('مديرية التربية والتعليم ${metadata.governorate}');
    range.cellStyle.bold = true;
    range.cellStyle.hAlign = xlsio.HAlignType.right;

    range = sheet.getRangeByIndex(2, 1, 2, 3);
    range.merge();
    range.setText('إدارة ${metadata.administration}');
    range.cellStyle.bold = true;
    range.cellStyle.hAlign = xlsio.HAlignType.right;

    range = sheet.getRangeByIndex(3, 1, 3, 3);
    range.merge();
    range.setText('مدرسة / ${metadata.school}');
    range.cellStyle.bold = true;
    range.cellStyle.hAlign = xlsio.HAlignType.right;

    // Center: Title
    range = sheet.getRangeByIndex(4, 6, 4, 15);
    range.merge();
    range.setText(
      'سجل رصد درجات فصل ${metadata.grade} / ${metadata.className}',
    );
    range.cellStyle.bold = true;
    range.cellStyle.fontSize = 14;
    range.cellStyle.hAlign = xlsio.HAlignType.center;

    // Top Right: Subject
    final subjectCell = sheet.getRangeByIndex(4, 18);
    subjectCell.setText('مادة : ${metadata.subject}');
    subjectCell.cellStyle.bold = true;
    subjectCell.cellStyle.hAlign = xlsio.HAlignType.right;
  }

  void _buildWeekHeaders(
    xlsio.Worksheet sheet,
    List<int> weeks,
    AssessmentExportMetadata metadata,
  ) {
    final dateFormat = DateFormat('yyyy\\M\\d');
    final arabicSubHeaders = [
      'أداء صفي',
      'كراسة الواجب',
      'كراسة النشاط',
      'تقييم أسبوعي',
      'مهام شفوية',
      'مهام مهارية',
      'مواظبة وسلوك',
      'المجموع',
    ];

    // Headers for B and C columns (Serial and Name)
    final serialHeader = sheet.getRangeByIndex(5, 2, 6, 2);
    serialHeader.merge();
    serialHeader.setText('م');
    _styleHeader(serialHeader);

    final nameHeader = sheet.getRangeByIndex(5, 3, 6, 3);
    nameHeader.merge();
    nameHeader.setText('الاسم');
    _styleHeader(nameHeader);

    for (var w = 0; w < weeks.length; w++) {
      final weekNum = weeks[w];
      final startCol = ExcelColumnConfig.getEvaluationColumn(weekNum, 0);
      final endCol = ExcelColumnConfig.getTotalColumn(weekNum);

      // Week Label (Row 5)
      final weekRange = sheet.getRangeByIndex(5, startCol, 5, endCol);
      weekRange.merge();
      final weekDate = metadata.weekStartDates?[weekNum];
      String label = 'الأسبوع ${_getArabicOrdinal(weekNum)}';
      if (weekDate != null) {
        label += ' ${dateFormat.format(weekDate)}';
      }
      weekRange.setText(label);
      _styleHeader(weekRange);

      // Sub-headers (Row 6)
      for (var s = 0; s < arabicSubHeaders.length; s++) {
        final subCell = sheet.getRangeByIndex(6, startCol + s);
        subCell.setText(arabicSubHeaders[s]);
        _styleSubHeader(subCell);
        if (s == 7) {
          subCell.cellStyle.backColor = '#D9E1F2'; // Totals header color
        }
      }
    }
  }

  void _writeStudentData(
    xlsio.Worksheet sheet,
    List<StudentAssessmentData> students,
    List<int> weeks,
  ) {
    for (var i = 0; i < students.length; i++) {
      final student = students[i];
      final row = ExcelColumnConfig.firstStudentRow + i;

      // Serial
      final serialCell = sheet.getRangeByIndex(
        row,
        ExcelColumnConfig.serialNumberColumn,
      );
      serialCell.setNumber((i + 1).toDouble());
      _addBorder(serialCell);
      serialCell.cellStyle.hAlign = xlsio.HAlignType.center;

      // Name
      final nameCell = sheet.getRangeByIndex(
        row,
        ExcelColumnConfig.studentNameColumn,
      );
      nameCell.setText(student.name);
      _addBorder(nameCell);
      nameCell.cellStyle.hAlign = xlsio.HAlignType.right;

      // Scores
      for (final weekNum in weeks) {
        final startCol = ExcelColumnConfig.getEvaluationColumn(weekNum, 0);
        final scores = student.weeklyScores[weekNum] ?? [];

        for (var e = 0; e < 7; e++) {
          final score = e < scores.length ? scores[e] : 0;
          final cell = sheet.getRangeByIndex(row, startCol + e);
          if (score > 0) {
            cell.setNumber(score.toDouble());
          } else {
            cell.setText('');
          }
          _addBorder(cell);
          cell.cellStyle.hAlign = xlsio.HAlignType.center;
        }

        // Total
        final total = student.getWeekTotal(weekNum);
        final totalCell = sheet.getRangeByIndex(
          row,
          ExcelColumnConfig.getTotalColumn(weekNum),
        );
        if (total > 0) {
          totalCell.setNumber(total.toDouble());
        } else {
          totalCell.setText('');
        }
        _addBorder(totalCell);
        totalCell.cellStyle.hAlign = xlsio.HAlignType.center;
        totalCell.cellStyle.bold = true;
        totalCell.cellStyle.backColor = '#F2F2F2';
      }
    }
  }

  void _styleHeader(xlsio.Range range) {
    range.cellStyle.bold = true;
    range.cellStyle.hAlign = xlsio.HAlignType.center;
    range.cellStyle.vAlign = xlsio.VAlignType.center;
    range.cellStyle.backColor = '#4472C4';
    range.cellStyle.fontColor = '#FFFFFF';
    _addBorder(range);
  }

  void _styleSubHeader(xlsio.Range range) {
    range.cellStyle.bold = true;
    range.cellStyle.hAlign = xlsio.HAlignType.center;
    range.cellStyle.vAlign = xlsio.VAlignType.center;
    range.cellStyle.fontSize = 9;
    range.cellStyle.wrapText = true;
    _addBorder(range);
  }

  void _addBorder(xlsio.Range range) {
    range.cellStyle.borders.all.lineStyle = xlsio.LineStyle.thin;
    range.cellStyle.borders.all.color = '#000000';
  }

  String _getArabicOrdinal(int number) {
    const ordinals = {
      1: 'الأول',
      2: 'الثاني',
      3: 'الثالث',
      4: 'الرابع',
      5: 'الخامس',
      6: 'السادس',
      7: 'السابع',
      8: 'الثامن',
      9: 'التاسع',
      10: 'العاشر',
      11: 'الحادي عشر',
      12: 'الثاني عشر',
      13: 'الثالث عشر',
      14: 'الرابع عشر',
      15: 'الخامس عشر',
    };
    return ordinals[number] ?? '$number';
  }
}
